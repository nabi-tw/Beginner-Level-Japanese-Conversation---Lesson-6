<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬èªä¼šè©±ç·´ç¿’ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </title>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f8ff;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .game-container {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            color: #ff6b6b;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .chat-area {
            background-color: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
        }
        
        .bot-message {
            background-color: #e3f2fd;
            text-align: left;
        }
        
        .user-message {
            background-color: #e8f5e9;
            text-align: right;
            margin-left: 50px;
        }
        
        .correction {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
            padding: 10px;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .new-topic-btn {
            background-color: #ff6b6b;
            margin-top: 10px;
            width: 100%;
        }
        
        .new-topic-btn:hover {
            background-color: #ff5252;
        }
        
        .progress {
            text-align: center;
            color: #666;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .reset-btn {
            background-color: #9c27b0;
            margin-top: 10px;
            width: 100%;
        }
        
        .reset-btn:hover {
            background-color: #7b1fa2;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ğŸŒ æ—¥æœ¬èªä¼šè©±ç·´ç¿’ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ  ğŸŒ</h1>
        
        <div class="card" id="questionCard">
            ã‚¯ãƒªãƒƒã‚¯ã—ã¦è³ªå•ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãï¼
        </div>
        
        <div class="chat-area" id="chatArea">
            <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="ã“ã“ã«ç­”ãˆã‚’æ›¸ã„ã¦ãã ã•ã„..." disabled>
            <button id="sendBtn" disabled>é€ä¿¡</button>
        </div>
        
        <button class="new-topic-btn" id="newTopicBtn" style="display:none;">ç·´ç¿’å¾—ä¸éŒ¯å–”ï¼é‚£æˆ‘å€‘ä¾†è©¦è©¦ä¸‹ä¸€é¡Œå¥½å—ï¼Ÿ</button>
        
        <div class="progress" id="progress"></div>
        
        <button class="reset-btn" id="resetBtn" style="display:none;">ã™ã¹ã¦ã®è³ªå•ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <script>
        class JapaneseConversationBot {
            constructor() {
                this.allQuestions = [
                    "ã“ã‚“ã«ã¡ã¯ã€‚ãŠåå‰ã¯ä½•ã§ã™ã‹ï¼Ÿ",
                    "ãã‚‡ã†ã¯ä½•æ›œæ—¥ã§ã™ã‹ï¼Ÿ",
                    "ã©ã“ã§ã”ã¯ã‚“ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ",
                    "ã„ã£ã—ã‚‡ã«æ˜ ç”»ã‚’è¦‹ã¾ã›ã‚“ã‹ï¼Ÿ",
                    "ãã®ã†ã€ä½•ã‚’ã—ã¾ã—ãŸã‹ï¼Ÿ",
                    "ä½•æ™‚ã«èµ·ãã¾ã™ã‹ï¼Ÿ",
                    "ã†ã¡ã¯ã©ã“ã§ã™ã‹ï¼Ÿ",
                    "ã©ã“ã§æ—¥æœ¬èªã‚’å‹‰å¼·ã—ã¾ã™ã‹ï¼Ÿ",
                    "é€±æœ«ã«ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ",
                    "ä½•æ™‚ã«å¯ã¾ã™ã‹ï¼Ÿ",
                    "æœã”ã¯ã‚“ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ",
                    "å­¦æ ¡ã¯ã©ã“ã§ã™ã‹ï¼Ÿ",
                    "ã‚ã—ãŸã€ã©ã“ã¸è¡Œãã¾ã™ã‹ï¼Ÿ",
                    "ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’é£²ã¿ã¾ã›ã‚“ã‹ï¼Ÿ",
                    "å­¦æ ¡ã¯ä½•æ™‚ã‹ã‚‰ä½•æ™‚ã¾ã§ã§ã™ã‹ï¼Ÿ",
                    "æ—¥æœ¬ã®é£Ÿã¹ç‰©ã‚’é£Ÿã¹ã¾ã—ãŸã‹ï¼Ÿ",
                    "ä½•ã§å­¦æ ¡ã¸è¡Œãã¾ã™ã‹ï¼Ÿ",
                    "ãã‚‡ã†ã€ä½•æ™‚ã«å®¶ã¸å¸°ã‚Šã¾ã™ã‹ï¼Ÿ",
                    "ä½•ã‚’è²·ã„ã¾ã™ã‹ï¼Ÿ",
                    "æœ¬ã‚’èª­ã¿ã¾ã™ã‹ï¼Ÿ"
                ];
                
                this.usedQuestions = this.loadUsedQuestions();
                this.availableQuestions = this.getAvailableQuestions();
                
                this.currentQuestion = "";
                this.conversationTurn = 0;
                this.maxTurns = 5;
                
                // ä¼šè©±ç®¡ç†
                this.conversationHistory = [];
                this.allAskedQuestions = new Set(); // ä»Šã¾ã§ã«èã„ãŸã™ã¹ã¦ã®è³ªå•
                this.extractedInfo = {}; // æŠ½å‡ºã—ãŸæƒ…å ±
                this.negativeCount = 0;
            }
            
            loadUsedQuestions() {
                const saved = localStorage.getItem('usedQuestions');
                return saved ? JSON.parse(saved) : [];
            }
            
            saveUsedQuestions() {
                localStorage.setItem('usedQuestions', JSON.stringify(this.usedQuestions));
            }
            
            getAvailableQuestions() {
                return this.allQuestions.filter(q => !this.usedQuestions.includes(q));
            }
            
            resetQuestions() {
                this.usedQuestions = [];
                this.availableQuestions = [...this.allQuestions];
                localStorage.removeItem('usedQuestions');
            }
            
            getRandomQuestion() {
                if (this.availableQuestions.length === 0) {
                    return null;
                }
                
                const index = Math.floor(Math.random() * this.availableQuestions.length);
                const question = this.availableQuestions[index];
                
                this.usedQuestions.push(question);
                this.saveUsedQuestions();
                
                this.availableQuestions = this.availableQuestions.filter(q => q !== question);
                
                return question;
            }
            
            getProgress() {
                return {
                    used: this.usedQuestions.length,
                    total: this.allQuestions.length,
                    remaining: this.availableQuestions.length
                };
            }
            
            extractVerb(userInput) {
                const verbPatterns = [
                    { pattern: /å‹‰å¼·ã—ã¾ã™/, verb: "å‹‰å¼·ã—ã¾ã™" },
                    { pattern: /è¦‹ã¾ã™/, verb: "è¦‹ã¾ã™" },
                    { pattern: /é£Ÿã¹ã¾ã™/, verb: "é£Ÿã¹ã¾ã™" },
                    { pattern: /é£²ã¿ã¾ã™/, verb: "é£²ã¿ã¾ã™" },
                    { pattern: /è¡Œãã¾ã™/, verb: "è¡Œãã¾ã™" },
                    { pattern: /æ¥ã¾ã™/, verb: "æ¥ã¾ã™" },
                    { pattern: /å¸°ã‚Šã¾ã™/, verb: "å¸°ã‚Šã¾ã™" },
                    { pattern: /ã—ã¾ã™/, verb: "ã—ã¾ã™" },
                    { pattern: /è²·ã„ã¾ã™/, verb: "è²·ã„ã¾ã™" },
                    { pattern: /èª­ã¿ã¾ã™/, verb: "èª­ã¿ã¾ã™" },
                    { pattern: /æ›¸ãã¾ã™/, verb: "æ›¸ãã¾ã™" },
                    { pattern: /èãã¾ã™/, verb: "èãã¾ã™" },
                    { pattern: /èµ·ãã¾ã™/, verb: "èµ·ãã¾ã™" },
                    { pattern: /å¯ã¾ã™/, verb: "å¯ã¾ã™" }
                ];
                
                const sortedPatterns = verbPatterns.sort((a, b) => b.verb.length - a.verb.length);
                
                for (let vp of sortedPatterns) {
                    if (userInput.match(vp.pattern)) {
                        return vp.verb;
                    }
                }
                
                return null;
            }
            
            convertToPast(verb) {
                const conversions = {
                    "è¦‹ã¾ã™": "è¦‹ã¾ã—ãŸ",
                    "é£Ÿã¹ã¾ã™": "é£Ÿã¹ã¾ã—ãŸ",
                    "é£²ã¿ã¾ã™": "é£²ã¿ã¾ã—ãŸ",
                    "è¡Œãã¾ã™": "è¡Œãã¾ã—ãŸ",
                    "æ¥ã¾ã™": "æ¥ã¾ã—ãŸ",
                    "å¸°ã‚Šã¾ã™": "å¸°ã‚Šã¾ã—ãŸ",
                    "ã—ã¾ã™": "ã—ã¾ã—ãŸ",
                    "å‹‰å¼·ã—ã¾ã™": "å‹‰å¼·ã—ã¾ã—ãŸ",
                    "è²·ã„ã¾ã™": "è²·ã„ã¾ã—ãŸ",
                    "èª­ã¿ã¾ã™": "èª­ã¿ã¾ã—ãŸ",
                    "æ›¸ãã¾ã™": "æ›¸ãã¾ã—ãŸ",
                    "èãã¾ã™": "èãã¾ã—ãŸ",
                    "èµ·ãã¾ã™": "èµ·ãã¾ã—ãŸ",
                    "å¯ã¾ã™": "å¯ã¾ã—ãŸ"
                };
                
                return conversions[verb] || verb;
            }
            
            extractInformation(userInput) {
                // äº¤é€šæ‰‹æ®µ
                if (userInput.includes("ãƒã‚¹") || userInput.includes("é›»è»Š") || 
                    userInput.includes("è‡ªè»¢è»Š") || userInput.includes("æ­©ã„ã¦") || 
                    userInput.includes("è»Š")) {
                    this.extractedInfo.transport = true;
                }
                
                // æ™‚é–“
                if (userInput.match(/\d+æ™‚/)) {
                    this.extractedInfo.time = true;
                }
                
                // å ´æ‰€
                if (userInput.includes("ã§") || userInput.includes("ã¸") || userInput.includes("ã«")) {
                    this.extractedInfo.place = true;
                }
                
                // äºº
                if (userInput.includes("ã¨") || userInput.includes("ä¸€äººã§") || userInput.includes("ã²ã¨ã‚Šã§")) {
                    this.extractedInfo.person = true;
                }
            }
            
            checkGrammar(userInput) {
                const corrections = [];
                const currentQ = this.conversationHistory.length > 0 
                    ? this.conversationHistory[this.conversationHistory.length - 1].question 
                    : this.currentQuestion;
                
                if (userInput.trim() === "ã„ã„ãˆ") {
                    if (currentQ.includes("é£Ÿã¹ã¾ã™ã‹")) {
                        corrections.push({
                            error: "ã„ã„ãˆ",
                            correction: "ã„ã„ãˆã€é£Ÿã¹ã¾ã›ã‚“",
                            explanation: "ã€Œã„ã„ãˆã€ã®å¾Œã«å‹•è©ã®å¦å®šå½¢ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"
                        });
                    } else if (currentQ.includes("é£²ã¿ã¾ã™ã‹")) {
                        corrections.push({
                            error: "ã„ã„ãˆ",
                            correction: "ã„ã„ãˆã€é£²ã¿ã¾ã›ã‚“",
                            explanation: "ã€Œã„ã„ãˆã€ã®å¾Œã«å‹•è©ã®å¦å®šå½¢ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"
                        });
                    } else if (currentQ.includes("ã—ã¾ã™ã‹")) {
                        corrections.push({
                            error: "ã„ã„ãˆ",
                            correction: "ã„ã„ãˆã€ã—ã¾ã›ã‚“",
                            explanation: "ã€Œã„ã„ãˆã€ã®å¾Œã«å‹•è©ã®å¦å®šå½¢ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"
                        });
                    } else if (currentQ.includes("è¡Œãã¾ã™ã‹")) {
                        corrections.push({
                            error: "ã„ã„ãˆ",
                            correction: "ã„ã„ãˆã€è¡Œãã¾ã›ã‚“",
                            explanation: "ã€Œã„ã„ãˆã€ã®å¾Œã«å‹•è©ã®å¦å®šå½¢ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"
                        });
                    } else if (currentQ.includes("èª­ã¿ã¾ã™ã‹")) {
                        corrections.push({
                            error: "ã„ã„ãˆ",
                            correction: "ã„ã„ãˆã€èª­ã¿ã¾ã›ã‚“",
                            explanation: "ã€Œã„ã„ãˆã€ã®å¾Œã«å‹•è©ã®å¦å®šå½¢ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"
                        });
                    }
                }
                
                if (userInput.includes("ã‚’") && userInput.includes("è¡Œãã¾ã™")) {
                    corrections.push({
                        error: "ã‚’è¡Œãã¾ã™",
                        correction: "ã¸è¡Œãã¾ã™ï¼ã«è¡Œãã¾ã™",
                        explanation: "å ´æ‰€ã¸è¡Œãã¨ãã¯ã€Œã¸ã€ã‹ã€Œã«ã€ã‚’ä½¿ã„ã¾ã™ã€‚"
                    });
                }
                
                return corrections;
            }
            
            generateResponse(userInput) {
                const corrections = this.checkGrammar(userInput);
                let response = "";
                
                if (corrections.length > 0) {
                    response = `ã¡ã‚‡ã£ã¨ã¡ãŒã„ã¾ã™ã€‚ã€Œ${corrections[0].correction}ã€ãŒã„ã„ã§ã™ã­ã€‚${corrections[0].explanation}\n\n`;
                }
                
                // æƒ…å ±ã‚’æŠ½å‡º
                this.extractInformation(userInput);
                
                // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
                const currentQ = this.conversationHistory.length > 0 
                    ? this.conversationHistory[this.conversationHistory.length - 1].question 
                    : this.currentQuestion;
                    
                this.conversationHistory.push({
                    question: currentQ,
                    answer: userInput
                });
                
                this.conversationTurn++;
                
                if (this.conversationTurn >= this.maxTurns) {
                    response += "ã„ã„ç·´ç¿’ã§ã—ãŸã­ï¼ã˜ã‚ƒã€ã¤ãã®è³ªå•ã‚’ã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ";
                    this.resetConversation();
                } else {
                    const followUpQuestion = this.getSmartFollowUpQuestion(userInput);
                    
                    if (followUpQuestion) {
                        response += followUpQuestion.prefix + followUpQuestion.question;
                        this.allAskedQuestions.add(followUpQuestion.question);
                        
                        // æ¬¡ã®è³ªå•ã¨ã—ã¦è¨˜éŒ²
                        this.conversationHistory.push({
                            question: followUpQuestion.question,
                            answer: null // ã¾ã ç­”ãˆã¦ã„ãªã„
                        });
                    } else {
                        response += "ã„ã„ç·´ç¿’ã§ã—ãŸã­ï¼";
                        this.conversationTurn = this.maxTurns;
                    }
                }
                
                return response;
            }
            
            getSmartFollowUpQuestion(userInput) {
                const lastQuestion = this.conversationHistory[this.conversationHistory.length - 1].question;
                const negativePatterns = ['ã¾ã›ã‚“', 'ãªã„', 'ã„ã„ãˆ', 'ã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“'];
                const isNegative = negativePatterns.some(pattern => userInput.includes(pattern));
                
                if (isNegative) {
                    this.negativeCount++;
                } else {
                    this.negativeCount = 0;
                }
                
                if (this.negativeCount >= 3) {
                    return null;
                }
                
                // ã™ã§ã«èã„ãŸè³ªå•ã‚’ãƒã‚§ãƒƒã‚¯
                const hasAsked = (question) => {
                    return this.allAskedQuestions.has(question) || 
                           this.conversationHistory.some(h => h.question === question);
                };
                
                // è³ªå•ãƒ‘ã‚¿ãƒ¼ãƒ³ã”ã¨ã®å‡¦ç†
                if (lastQuestion.includes("ãŠåå‰ã¯ä½•ã§ã™ã‹")) {
                    if (!hasAsked("å­¦æ ¡ã¯ã©ã“ã§ã™ã‹ï¼Ÿ")) {
                        return { prefix: "ã¯ã˜ã‚ã¾ã—ã¦ã€‚", question: "å­¦æ ¡ã¯ã©ã“ã§ã™ã‹ï¼Ÿ" };
                    }
                }
                
                if (lastQuestion.includes("ãã‚‡ã†ã¯ä½•æ›œæ—¥ã§ã™ã‹")) {
                    if (!hasAsked("ãã‚‡ã†ã¯ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ")) {
                        return { prefix: "ãã†ã§ã™ã­ã€‚", question: "ãã‚‡ã†ã¯ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ" };
                    }
                }
                
                if (lastQuestion.includes("ã©ã“ã§ã”ã¯ã‚“ã‚’é£Ÿã¹ã¾ã™ã‹")) {
                    if (userInput.includes("ä¸€äººã§") || userInput.includes("ã²ã¨ã‚Šã§")) {
                        if (!hasAsked("ä½•ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ä½•ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else if (userInput.includes("ã¨")) {
                        if (!hasAsked("ä½•ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ã„ã„ã§ã™ã­ã€‚", question: "ä½•ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else if (userInput.includes("å®¶") || userInput.includes("ã†ã¡")) {
                        if (!hasAsked("ã ã‚Œã¨é£Ÿã¹ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ã ã‚Œã¨é£Ÿã¹ã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else {
                        if (!hasAsked("ä½•ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ã„ã„ã§ã™ã­ã€‚", question: "ä½•ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ" };
                        }
                    }
                }
                
                if (lastQuestion.includes("ã„ã£ã—ã‚‡ã«æ˜ ç”»ã‚’è¦‹ã¾ã›ã‚“ã‹")) {
                    if (isNegative) {
                        if (!hasAsked("ãŠèŒ¶ã‚’é£²ã¿ã¾ã›ã‚“ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚ã˜ã‚ƒã€", question: "ãŠèŒ¶ã‚’é£²ã¿ã¾ã›ã‚“ã‹ï¼Ÿ" };
                        }
                    } else {
                        if (!hasAsked("ã©ã“ã§è¦‹ã¾ã—ã‚‡ã†ã‹ï¼Ÿ")) {
                            return { prefix: "ã„ã„ã§ã™ã­ï¼", question: "ã©ã“ã§è¦‹ã¾ã—ã‚‡ã†ã‹ï¼Ÿ" };
                        }
                    }
                }
                
                if (lastQuestion.includes("ãã®ã†ã€ä½•ã‚’ã—ã¾ã—ãŸã‹")) {
                    if (isNegative || userInput.includes("ä½•ã‚‚")) {
                        if (!hasAsked("ãã‚‡ã†ã¯ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ãã‚‡ã†ã¯ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else if (userInput.includes("å‹‰å¼·")) {
                        if (!hasAsked("ä½•ã‚’å‹‰å¼·ã—ã¾ã—ãŸã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ä½•ã‚’å‹‰å¼·ã—ã¾ã—ãŸã‹ï¼Ÿ" };
                        }
                    } else {
                        if (!hasAsked("ã©ã“ã§ã—ã¾ã—ãŸã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ã©ã“ã§ã—ã¾ã—ãŸã‹ï¼Ÿ" };
                        }
                    }
                }
                
                if (lastQuestion.includes("ä½•æ™‚ã«èµ·ãã¾ã™ã‹")) {
                    if (!hasAsked("æœã”ã¯ã‚“ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ")) {
                        return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "æœã”ã¯ã‚“ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ" };
                    }
                }
                
                if (lastQuestion.includes("ä½•æ™‚ã«å¯ã¾ã™ã‹")) {
                    if (!hasAsked("æœã€ä½•æ™‚ã«èµ·ãã¾ã™ã‹ï¼Ÿ")) {
                        return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "æœã€ä½•æ™‚ã«èµ·ãã¾ã™ã‹ï¼Ÿ" };
                    }
                }
                
                if (lastQuestion.includes("æœã”ã¯ã‚“ã‚’é£Ÿã¹ã¾ã™ã‹")) {
                    if (isNegative) {
                        if (!hasAsked("ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’é£²ã¿ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’é£²ã¿ã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else {
                        if (!hasAsked("ä½•ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ã„ã„ã§ã™ã­ã€‚", question: "ä½•ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ" };
                        }
                    }
                }
                
                if (lastQuestion.includes("ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’é£²ã¿ã¾ã™ã‹")) {
                    if (isNegative) {
                        if (!hasAsked("ãŠèŒ¶ã‚’é£²ã¿ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ãŠèŒ¶ã‚’é£²ã¿ã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else {
                        if (!hasAsked("ã©ã“ã§é£²ã¿ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ã„ã„ã§ã™ã­ã€‚", question: "ã©ã“ã§é£²ã¿ã¾ã™ã‹ï¼Ÿ" };
                        }
                    }
                }
                
                if (lastQuestion.includes("ã©ã“ã§æ—¥æœ¬èªã‚’å‹‰å¼·ã—ã¾ã™ã‹")) {
                    if (userInput.includes("å¡¾") || userInput.includes("å­¦æ ¡")) {
                        if (!hasAsked("ä½•æ™‚ã‹ã‚‰ä½•æ™‚ã¾ã§å‹‰å¼·ã—ã¾ã™ã‹ï¼Ÿ") && !this.extractedInfo.time) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ä½•æ™‚ã‹ã‚‰ä½•æ™‚ã¾ã§å‹‰å¼·ã—ã¾ã™ã‹ï¼Ÿ" };
                        } else if (!hasAsked("æ¯æ—¥å‹‰å¼·ã—ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "æ¯æ—¥å‹‰å¼·ã—ã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else {
                        if (!hasAsked("æ¯æ—¥å‹‰å¼·ã—ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "æ¯æ—¥å‹‰å¼·ã—ã¾ã™ã‹ï¼Ÿ" };
                        }
                    }
                }
                
                if (lastQuestion.includes("é€±æœ«ã«ä½•ã‚’ã—ã¾ã™ã‹")) {
                    const verb = this.extractVerb(userInput);
                    if (userInput.includes("æ˜ ç”»ã‚’è¦‹ã¾ã™")) {
                        if (userInput.includes("ã¨")) {
                            if (!hasAsked("ã©ã“ã§è¦‹ã¾ã™ã‹ï¼Ÿ")) {
                                return { prefix: "ã„ã„ã§ã™ã­ã€‚", question: "ã©ã“ã§è¦‹ã¾ã™ã‹ï¼Ÿ" };
                            }
                        } else if (!hasAsked("ã ã‚Œã¨è¦‹ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ã„ã„ã§ã™ã­ã€‚", question: "ã ã‚Œã¨è¦‹ã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else if (userInput.includes("å‹‰å¼·")) {
                        if (!hasAsked("ã©ã“ã§å‹‰å¼·ã—ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ã©ã“ã§å‹‰å¼·ã—ã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else if (userInput.includes("ä¸€äººã§")) {
                        if (verb && verb !== "ã—ã¾ã™" && !hasAsked(`ã©ã“ã§${verb}ã‹ï¼Ÿ`)) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: `ã©ã“ã§${verb}ã‹ï¼Ÿ` };
                        }
                    } else if (!userInput.includes("ã¨") && !this.extractedInfo.person) {
                        if (verb && verb !== "ã—ã¾ã™" && !hasAsked(`ã ã‚Œã¨${verb}ã‹ï¼Ÿ`)) {
                            return { prefix: "ã„ã„ã§ã™ã­ã€‚", question: `ã ã‚Œã¨${verb}ã‹ï¼Ÿ` };
                        }
                    }
                }
                
                if (lastQuestion.includes("å­¦æ ¡ã¯ã©ã“ã§ã™ã‹")) {
                    if (!hasAsked("ä½•ã§å­¦æ ¡ã¸è¡Œãã¾ã™ã‹ï¼Ÿ") && !this.extractedInfo.transport) {
                        return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ä½•ã§å­¦æ ¡ã¸è¡Œãã¾ã™ã‹ï¼Ÿ" };
                    } else if (!hasAsked("ä½•æ™‚ã«å­¦æ ¡ã¸è¡Œãã¾ã™ã‹ï¼Ÿ") && !this.extractedInfo.time) {
                        return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ä½•æ™‚ã«å­¦æ ¡ã¸è¡Œãã¾ã™ã‹ï¼Ÿ" };
                    }
                }
                
                if (lastQuestion.includes("ä½•ã§å­¦æ ¡ã¸è¡Œãã¾ã™ã‹")) {
                    if (!hasAsked("ä½•æ™‚ã«å­¦æ ¡ã¸è¡Œãã¾ã™ã‹ï¼Ÿ") && !this.extractedInfo.time) {
                        return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ä½•æ™‚ã«å­¦æ ¡ã¸è¡Œãã¾ã™ã‹ï¼Ÿ" };
                    } else if (!hasAsked("å­¦æ ¡ã¯ä½•æ™‚ã‹ã‚‰ä½•æ™‚ã¾ã§ã§ã™ã‹ï¼Ÿ")) {
                        return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "å­¦æ ¡ã¯ä½•æ™‚ã‹ã‚‰ä½•æ™‚ã¾ã§ã§ã™ã‹ï¼Ÿ" };
                    }
                }
                
                if (lastQuestion.includes("ã‚ã—ãŸã€ã©ã“ã¸è¡Œãã¾ã™ã‹")) {
                    if (userInput.includes("ä¼šç¤¾") || userInput.includes("å­¦æ ¡")) {
                        if (!hasAsked("ä½•æ™‚ã«è¡Œãã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ä½•æ™‚ã«è¡Œãã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else if (!hasAsked("ã ã‚Œã¨è¡Œãã¾ã™ã‹ï¼Ÿ") && !this.extractedInfo.person) {
                        return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ã ã‚Œã¨è¡Œãã¾ã™ã‹ï¼Ÿ" };
                    }
                }
                
                if (lastQuestion.includes("æ—¥æœ¬ã®é£Ÿã¹ç‰©ã‚’é£Ÿã¹ã¾ã—ãŸã‹")) {
                    if (isNegative) {
                        if (!hasAsked("ä½•ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ä½•ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else {
                        if (!hasAsked("ä½•ã‚’é£Ÿã¹ã¾ã—ãŸã‹ï¼Ÿ")) {
                            return { prefix: "ã„ã„ã§ã™ã­ã€‚", question: "ä½•ã‚’é£Ÿã¹ã¾ã—ãŸã‹ï¼Ÿ" };
                        }
                    }
                }
                
                if (lastQuestion.includes("ä½•ã‚’é£Ÿã¹ã¾ã—ãŸã‹")) {
                    if (!hasAsked("ã©ã“ã§é£Ÿã¹ã¾ã—ãŸã‹ï¼Ÿ")) {
                        return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ã©ã“ã§é£Ÿã¹ã¾ã—ãŸã‹ï¼Ÿ" };
                    }
                }
                
                if (lastQuestion.includes("ãã‚‡ã†ã€ä½•æ™‚ã«å®¶ã¸å¸°ã‚Šã¾ã™ã‹")) {
                    if (!hasAsked("ã ã‚Œã¨å¸°ã‚Šã¾ã™ã‹ï¼Ÿ") && !this.extractedInfo.person) {
                        return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "ã ã‚Œã¨å¸°ã‚Šã¾ã™ã‹ï¼Ÿ" };
                    }
                }
                
                if (lastQuestion.includes("ä½•ã‚’è²·ã„ã¾ã™ã‹")) {
                    if (!hasAsked("ã©ã“ã§è²·ã„ã¾ã™ã‹ï¼Ÿ")) {
                        return { prefix: "ã„ã„ã§ã™ã­ã€‚", question: "ã©ã“ã§è²·ã„ã¾ã™ã‹ï¼Ÿ" };
                    }
                }
                
                if (lastQuestion.includes("æœ¬ã‚’èª­ã¿ã¾ã™ã‹")) {
                    if (isNegative) {
                        if (!hasAsked("æ–°èã‚’èª­ã¿ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ãã†ã§ã™ã‹ã€‚", question: "æ–°èã‚’èª­ã¿ã¾ã™ã‹ï¼Ÿ" };
                        }
                    } else {
                        if (!hasAsked("ä½•ã®æœ¬ã‚’èª­ã¿ã¾ã™ã‹ï¼Ÿ")) {
                            return { prefix: "ã„ã„ã§ã™ã­ã€‚", question: "ä½•ã®æœ¬ã‚’èª­ã¿ã¾ã™ã‹ï¼Ÿ" };
                        }
                    }
                }
                
                return null;
            }
            
            resetConversation() {
                this.conversationHistory = [];
                this.allAskedQuestions.clear();
                this.extractedInfo = {};
                this.negativeCount = 0;
            }
        }
        
        // ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–
        const bot = new JapaneseConversationBot();
        const questionCard = document.getElementById('questionCard');
        const chatArea = document.getElementById('chatArea');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const newTopicBtn = document.getElementById('newTopicBtn');
        const progressDiv = document.getElementById('progress');
        const resetBtn = document.getElementById('resetBtn');
        
        function updateProgress() {
            const progress = bot.getProgress();
            progressDiv.textContent = `è³ªå•: ${progress.used}/${progress.total} å®Œäº† (æ®‹ã‚Š: ${progress.remaining})`;
            
            if (progress.remaining === 0) {
                questionCard.textContent = 'ã™ã¹ã¦ã®è³ªå•ã‚’å®Œäº†ã—ã¾ã—ãŸï¼ğŸ‰';
                questionCard.style.pointerEvents = 'none';
                resetBtn.style.display = 'block';
            }
        }
        
        updateProgress();
        
        questionCard.addEventListener('click', () => {
            const question = bot.getRandomQuestion();
            
            if (question === null) {
                alert('ã™ã¹ã¦ã®è³ªå•ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸï¼ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            bot.currentQuestion = question;
            bot.conversationTurn = 0;
            bot.resetConversation();
            bot.allAskedQuestions.add(question);
            
            questionCard.textContent = bot.currentQuestion;
            questionCard.style.pointerEvents = 'none';
            
            // æœ€åˆã®è³ªå•ã‚’å±¥æ­´ã«è¿½åŠ 
            bot.conversationHistory.push({
                question: question,
                answer: null
            });
            
            addMessage(bot.currentQuestion, 'bot');
            
            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
            
            updateProgress();
        });
        
        function addMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = message;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;
            
            addMessage(message, 'user');
            userInput.value = '';
            
            setTimeout(() => {
                const response = bot.generateResponse(message);
                addMessage(response, 'bot');
                
                if (bot.conversationTurn >= bot.maxTurns) {
                    userInput.disabled = true;
                    sendBtn.disabled = true;
                    newTopicBtn.style.display = 'block';
                }
            }, 1000);
        }
        
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        newTopicBtn.addEventListener('click', () => {
            chatArea.innerHTML = '';
            
            const progress = bot.getProgress();
            if (progress.remaining > 0) {
                questionCard.textContent = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦è³ªå•ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãï¼';
                questionCard.style.pointerEvents = 'auto';
            }
            
            newTopicBtn.style.display = 'none';
            userInput.disabled = true;
            sendBtn.disabled = true;
            bot.resetConversation();
        });
        
        resetBtn.addEventListener('click', () => {
            if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®è³ªå•ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                bot.resetQuestions();
                chatArea.innerHTML = '';
                questionCard.textContent = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦è³ªå•ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãï¼';
                questionCard.style.pointerEvents = 'auto';
                resetBtn.style.display = 'none';
                updateProgress();
            }
        });
    </script>
</body>
</html>
